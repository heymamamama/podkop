name: Build packages

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g. v0.8.0)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  preparation:
    name: Setup build version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
      - id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(git describe --tags --exact-match 2>/dev/null || echo "0.$(date +%d%m%Y)")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "üì¶ Building version: $VERSION" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build ${{ matrix.package_type }} packages
    runs-on: ubuntu-latest
    needs: preparation
    strategy:
      matrix:
        include:
          - { package_type: ipk }
          - { package_type: apk }
    steps:
      - uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.package_type }}
        uses: docker/build-push-action@v6.18.0
        with:
          file: ./Dockerfile-${{ matrix.package_type }}
          context: .
          tags: podkop:ci-${{ matrix.package_type }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PODKOP_VERSION=${{ needs.preparation.outputs.version }}

      - name: Create ${{ matrix.package_type }} Docker container
        run: docker create --name ${{ matrix.package_type }} podkop:ci-${{ matrix.package_type }}

      - name: Copy files from ${{ matrix.package_type }} Docker container
        run: |
          mkdir -p ./bin/${{ matrix.package_type }}
          docker cp ${{ matrix.package_type }}:/builder/bin/packages/x86_64/utilities/. ./bin/${{ matrix.package_type }}/
          docker cp ${{ matrix.package_type }}:/builder/bin/packages/x86_64/luci/. ./bin/${{ matrix.package_type }}/

      - name: List built packages
        run: |
          echo "üì¶ Built packages:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la ./bin/${{ matrix.package_type }}/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # IPK uses underscore `_` in filenames, while APK uses only dash `-`
      - name: Fix naming difference between build for packages (replace _ with -)
        if: matrix.package_type == 'ipk'
        shell: bash
        run: |
          for f in ./bin/${{ matrix.package_type }}/*.${{ matrix.package_type }}; do
            [ -e "$f" ] || continue
            base=$(basename "$f")
            newname=$(echo "$base" | sed 's/_/-/g')
            mv "$f" "./bin/${{ matrix.package_type }}/$newname"
          done

      - name: Filter files
        shell: bash
        run: |
          VERSION="${{ needs.preparation.outputs.version }}"

          mkdir -p ./filtered-bin/${{ matrix.package_type }}
          cp ./bin/${{ matrix.package_type }}/luci-i18n-podkop-ru-*.${{ matrix.package_type }} "./filtered-bin/${{ matrix.package_type }}/luci-i18n-podkop-ru-${VERSION}.${{ matrix.package_type }}" || true
          cp ./bin/${{ matrix.package_type }}/podkop-*.${{ matrix.package_type }} ./filtered-bin/${{ matrix.package_type }}/
          cp ./bin/${{ matrix.package_type }}/luci-app-podkop-*.${{ matrix.package_type }} ./filtered-bin/${{ matrix.package_type }}/

      - name: Remove Docker container
        run: docker rm ${{ matrix.package_type }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: release-files-${{ github.ref_name || needs.preparation.outputs.version }}-${{ matrix.package_type }}
          path: ./filtered-bin/${{ matrix.package_type }}/*.${{ matrix.package_type }}
          retention-days: 7
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [preparation, build]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v5.0.0

      - name: Create release dir
        run: mkdir -p ./filtered-bin/release

      - name: Download ipk artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-files-${{ github.ref_name }}-ipk
          path: ./filtered-bin/release

      - name: Download apk artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-files-${{ github.ref_name }}-apk
          path: ./filtered-bin/release

      - name: List release files
        run: |
          echo "üì¶ Release files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la ./filtered-bin/release/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Release
        uses: softprops/action-gh-release@v2.4.0
        with:
          files: ./filtered-bin/release/*.*
          draft: false
          prerelease: true
          name: ${{ github.ref_name }} (Experimental Fork)
          tag_name: ${{ github.ref_name }}
          body: |
            ## üß™ Experimental Fork Release

            > ‚ö†Ô∏è This is an experimental fork of [Podkop](https://github.com/itdoginfo/podkop)

            ### üì¶ Packages
            - `podkop-*.ipk` / `podkop-*.apk` - Main package
            - `luci-app-podkop-*.ipk` / `luci-app-podkop-*.apk` - LuCI interface
            - `luci-i18n-podkop-ru-*.ipk` / `*.apk` - Russian translation

            ### üöÄ Installation
            ```bash
            # Download and install
            wget <package-url>
            opkg install <package-file>
            ```

            ### ‚ú® New Features in this Fork
            - Subscription support (sing-box & base64)
            - Tag-based filtering
            - Auto-update via cron
